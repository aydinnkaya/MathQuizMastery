//
//  CategoryIconsHelper.swift
//  MathQuizMastery
//
//  Created by Aydƒ±nKaya on 22.07.2025.
//

import UIKit
import Foundation

// MARK: - Category Icons Helper
/// Kategori ikonlarƒ±nƒ± y√∂netmek i√ßin yardƒ±mcƒ± sƒ±nƒ±f
/// Bu sƒ±nƒ±f hem sistemsel ikonlarƒ± hem de √∂zel ikon dosyalarƒ±nƒ± destekler
class CategoryIconsHelper {
    
    // MARK: - Singleton
    static let shared = CategoryIconsHelper()
    private init() {}
    
    // MARK: - Icon Mapping
    /// Kategori ikonlarƒ±nƒ±n mapping'i
    /// Her kategori i√ßin ikon ismi ve fall-back sistem ikonu tanƒ±mlanƒ±r
    private let iconMappings: [String: IconInfo] = [
        // Temel ƒ∞≈ülemler
        "category_addition": IconInfo(
            customIcon: "category_addition",
            systemIcon: "plus.circle.fill",
            backgroundColor: .systemBlue
        ),
        
        "category_subtraction": IconInfo(
            customIcon: "category_subtraction",
            systemIcon: "minus.circle.fill",
            backgroundColor: .systemOrange
        ),
        
        "category_multiplication": IconInfo(
            customIcon: "category_multiplication",
            systemIcon: "multiply.circle.fill",
            backgroundColor: .systemPurple
        ),
        
        // √ñzel Kategoriler
        "category_multiplication_table": IconInfo(
            customIcon: "category_multiplication_table",
            systemIcon: "tablecells.fill",
            backgroundColor: .systemRed
        ),
        
        "category_order_operations": IconInfo(
            customIcon: "category_order_operations",
            systemIcon: "function",
            backgroundColor: .systemBlue
        ),
        
        "category_negative_numbers": IconInfo(
            customIcon: "category_negative_numbers",
            systemIcon: "minus.plus.batteryblock.fill",
            backgroundColor: .systemGreen
        ),
        
        // Kesirler ve Y√ºzdeler
        "category_fractions": IconInfo(
            customIcon: "category_fractions",
            systemIcon: "divide.circle.fill",
            backgroundColor: .systemIndigo
        ),
        
        "category_percentages": IconInfo(
            customIcon: "category_percentages",
            systemIcon: "percent",
            backgroundColor: .systemPurple
        ),
        
        // Geometri
        "category_geometric_shapes": IconInfo(
            customIcon: "category_geometric_shapes",
            systemIcon: "triangle.circle.fill",
            backgroundColor: .systemYellow
        ),
        
        // Zaman
        "category_time_clock": IconInfo(
            customIcon: "category_time_clock",
            systemIcon: "clock.fill",
            backgroundColor: .systemTeal
        ),
        
        // Zihinsel Matematik
        "category_mental_math": IconInfo(
            customIcon: "category_mental_math",
            systemIcon: "brain.head.profile",
            backgroundColor: .systemGreen
        ),
        
        // Rastgele Karƒ±≈üƒ±k
        "category_random_mixed": IconInfo(
            customIcon: "category_random_mixed",
            systemIcon: "shuffle.circle.fill",
            backgroundColor: .systemPink
        )
    ]
    
    // MARK: - Public Methods
    
    /// Belirtilen ikon ismini kullanarak UIImage d√∂ner
    /// - Parameter iconName: ƒ∞kon ismi
    /// - Returns: UIImage veya nil
    func getIcon(for iconName: String) -> UIImage? {
        guard let iconInfo = iconMappings[iconName] else {
            // Mapping bulunamazsa varsayƒ±lan ikon d√∂nd√ºr
            return getDefaultIcon()
        }
        
        // √ñnce custom ikonu dene
        if let customImage = UIImage(named: iconInfo.customIcon) {
            return customImage.withRenderingMode(.alwaysTemplate)
        }
        
        // Custom ikon bulunamazsa sistem ikonunu kullan
        if let systemImage = UIImage(systemName: iconInfo.systemIcon) {
            let config = UIImage.SymbolConfiguration(pointSize: 24, weight: .medium)
            return systemImage.withConfiguration(config).withRenderingMode(.alwaysTemplate)
        }
        
        // Her ≈üey ba≈üarƒ±sƒ±z olursa varsayƒ±lan ikon
        return getDefaultIcon()
    }
    
    /// Kategori i√ßin renk bilgisini d√∂ner
    /// - Parameter iconName: ƒ∞kon ismi
    /// - Returns: UIColor
    func getBackgroundColor(for iconName: String) -> UIColor {
        return iconMappings[iconName]?.backgroundColor ?? .systemBlue
    }
    
    /// T√ºm kategori ikonlarƒ±nƒ±n mevcut olup olmadƒ±ƒüƒ±nƒ± kontrol eder
    /// - Returns: Kontrol raporu
    func validateIcons() -> IconValidationReport {
        var missingCustomIcons: [String] = []
        var availableIcons: [String] = []
        var systemFallbacks: [String] = []
        
        for (iconName, iconInfo) in iconMappings {
            if UIImage(named: iconInfo.customIcon) != nil {
                availableIcons.append(iconName)
            } else {
                missingCustomIcons.append(iconName)
                if UIImage(systemName: iconInfo.systemIcon) != nil {
                    systemFallbacks.append(iconName)
                }
            }
        }
        
        return IconValidationReport(
            totalIcons: iconMappings.count,
            availableCustomIcons: availableIcons.count,
            missingCustomIcons: missingCustomIcons,
            systemFallbacks: systemFallbacks
        )
    }
    
    /// Varsayƒ±lan ikonu d√∂ner
    /// - Returns: Varsayƒ±lan UIImage
    private func getDefaultIcon() -> UIImage? {
        let config = UIImage.SymbolConfiguration(pointSize: 24, weight: .medium)
        return UIImage(systemName: "questionmark.circle.fill")?
            .withConfiguration(config)
            .withRenderingMode(.alwaysTemplate)
    }
}

// MARK: - Icon Info Structure
/// ƒ∞kon bilgilerini tutan yapƒ±
struct IconInfo {
    let customIcon: String          // √ñzel ikon dosya adƒ±
    let systemIcon: String          // Sistem ikonu adƒ± (fallback)
    let backgroundColor: UIColor    // Arka plan rengi
}

// MARK: - Icon Validation Report
/// ƒ∞kon doƒürulama raporu yapƒ±sƒ±
struct IconValidationReport {
    let totalIcons: Int                    // Toplam ikon sayƒ±sƒ±
    let availableCustomIcons: Int          // Mevcut custom ikon sayƒ±sƒ±
    let missingCustomIcons: [String]       // Eksik custom ikonlar
    let systemFallbacks: [String]          // Sistem ikonu kullanƒ±lan kategoriler
    
    /// Validasyon ba≈üarƒ±lƒ± mƒ±?
    var isValid: Bool {
        return missingCustomIcons.isEmpty
    }
    
    /// Raporu konsola yazdƒ±r
    func printReport() {
        print("üîç ƒ∞kon Validasyon Raporu:")
        print("üìä Toplam ƒ∞kon: \(totalIcons)")
        print("‚úÖ Mevcut Custom ƒ∞konlar: \(availableCustomIcons)")
        print("‚ö†Ô∏è Eksik Custom ƒ∞konlar: \(missingCustomIcons.count)")
        
        if !missingCustomIcons.isEmpty {
            print("üö® Eksik ƒ∞konlar:")
            missingCustomIcons.forEach { iconName in
                print("   - \(iconName)")
            }
        }
        
        if !systemFallbacks.isEmpty {
            print("üîÑ Sistem ƒ∞konu Kullanƒ±lanlar:")
            systemFallbacks.forEach { iconName in
                print("   - \(iconName)")
            }
        }
        
        print("üèÅ Durum: \(isValid ? "‚úÖ T√ºm ikonlar mevcut" : "‚ö†Ô∏è Bazƒ± ikonlar eksik")")
    }
}

// MARK: - Category Icons Extension
/// MathCategory i√ßin ikon yardƒ±mcƒ± extension'ƒ±
extension MathCategory {
    
    /// Kategorinin ikonunu d√∂ner
    var icon: UIImage? {
        return CategoryIconsHelper.shared.getIcon(for: iconName)
    }
    
    /// Kategorinin arka plan rengini d√∂ner (IconHelper'dan)
    var helperBackgroundColor: UIColor {
        return CategoryIconsHelper.shared.getBackgroundColor(for: iconName)
    }
}

// MARK: - Icon Assets Generator
/// Development ama√ßlƒ± - ikon asset'lerini programlƒ± olarak olu≈üturmak i√ßin
class CategoryIconGenerator {
    
    /// Kategori i√ßin programlƒ± ikon olu≈üturur (√∂zel ikon dosyasƒ± yoksa)
    /// - Parameters:
    ///   - category: Kategori bilgisi
    ///   - size: ƒ∞kon boyutu
    /// - Returns: Olu≈üturulan UIImage
    static func generateIcon(for category: MathCategory, size: CGSize = CGSize(width: 60, height: 60)) -> UIImage? {
        
        // Canvas olu≈ütur
        let renderer = UIGraphicsImageRenderer(size: size)
        
        return renderer.image { context in
            let cgContext = context.cgContext
            
            // Arka plan circle
            cgContext.setFillColor(category.backgroundColor.cgColor)
            cgContext.fillEllipse(in: CGRect(origin: .zero, size: size))
            
            // ƒ∞kon i√ßin sistem sembol√º
            let symbolName = getSymbolName(for: category)
            let config = UIImage.SymbolConfiguration(pointSize: size.width * 0.4, weight: .medium)
            
            if let symbolImage = UIImage(systemName: symbolName)?.withConfiguration(config) {
                let symbolSize = symbolImage.size
                let symbolOrigin = CGPoint(
                    x: (size.width - symbolSize.width) / 2,
                    y: (size.height - symbolSize.height) / 2
                )
                
                // Beyaz renkte symbol √ßiz
                cgContext.saveGState()
                cgContext.translateBy(x: symbolOrigin.x, y: symbolOrigin.y)
                cgContext.scaleBy(x: 1, y: -1)
                cgContext.translateBy(x: 0, y: -symbolSize.height)
                
                if let cgImage = symbolImage.cgImage {
                    cgContext.setFillColor(UIColor.white.cgColor)
                    cgContext.draw(cgImage, in: CGRect(origin: .zero, size: symbolSize))
                }
                
                cgContext.restoreGState()
            }
        }
    }
    
    /// Kategori tipine g√∂re uygun sistem sembol ismini d√∂ner
    /// - Parameter category: Kategori
    /// - Returns: Sistem sembol ismi
    private static func getSymbolName(for category: MathCategory) -> String {
        switch category.expressionType {
        case .addition:
            return "plus"
        case .subtraction:
            return "minus"
        case .multiplication:
            return "multiply"
        case .multiplicationTable:
            return "grid"
        case .orderOfOperations:
            return "function"
        case .negativeNumbers:
            return "plusminus"
        case .fractions:
            return "divide"
        case .percentages:
            return "percent"
        case .geometricShapes:
            return "triangle"
        case .timeAndClock:
            return "clock"
        case .mentalMath:
            return "brain"
        case .randomMixed:
            return "shuffle"
        default:
            return "questionmark"
        }
    }
}

// MARK: - Usage Example and Setup
extension CategoryIconsHelper {
    
    /// Geli≈ütirme ortamƒ±nda ikon kontrol√º yapmak i√ßin yardƒ±mcƒ± method
    func performIconCheck() {
        print("üîß Kategori ƒ∞konlarƒ± Kontrol Ediliyor...")
        
        let report = validateIcons()
        report.printReport()
        
        // Eƒüer custom ikonlar eksikse, programlƒ± ikonlarƒ± olu≈ütur
        if !report.isValid {
            print("üé® Eksik ikonlar i√ßin programlƒ± ikonlar olu≈üturuluyor...")
            generateMissingIcons(report.missingCustomIcons)
        }
    }
    
    /// Eksik ikonlarƒ± programlƒ± olarak olu≈üturur (development i√ßin)
    private func generateMissingIcons(_ missingIcons: [String]) {
        let categories = MathCategoryFactory.shared.getAllCategories()
        
        for iconName in missingIcons {
            if let category = categories.first(where: { $0.iconName == iconName }) {
                if let generatedIcon = CategoryIconGenerator.generateIcon(for: category) {
                    print("‚ú® Programlƒ± ikon olu≈üturuldu: \(iconName)")
                    // Burada ikon'u kaydetme i≈ülemi yapƒ±labilir
                    // saveGeneratedIcon(generatedIcon, name: iconName)
                }
            }
        }
    }
}
