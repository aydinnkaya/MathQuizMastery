//
//  CategoryCollectionViewCell.swift
//  MathQuizMastery
//
//  Created by AydÄ±n KAYA on 23.07.2025.
//

import UIKit

// MARK: - Category Collection View Cell
/// Matematik kategorisi kartÄ±nÄ± gÃ¶steren collection view cell'i
class CategoryCollectionViewCell: UICollectionViewCell {
    
    // MARK: - IBOutlets
    @IBOutlet weak var containerView: UIView!          // Ana container view
    @IBOutlet weak var iconImageView: UIImageView!     // Kategori ikonu
    @IBOutlet weak var titleLabel: UILabel!            // Kategori baÅŸlÄ±ÄŸÄ±
    @IBOutlet weak var newBadgeLabel: UILabel!         // "YENÄ°" etiketi
    @IBOutlet weak var backgroundGradientView: UIView! // Gradient arka plan view
    
    // MARK: - Properties
    private var gradientLayer: CAGradientLayer?        // Gradient katmanÄ±
    private var blurEffectView: UIVisualEffectView?    // Blur efekt view
    private var category: MathCategory?                // Ä°liÅŸkili kategori
    
    // MARK: - Lifecycle
    
    override func awakeFromNib() {
        super.awakeFromNib()
        setupUI()           // UI bileÅŸenlerini ayarla
        setupLiquidGlass()  // Liquid glass efekti kur
        print("âœ… CategoryCollectionViewCell awakeFromNib tamamlandÄ±")
    }
    
    override func prepareForReuse() {
        super.prepareForReuse()
        // Cell yeniden kullanÄ±lmadan Ã¶nce temizlik yap
        resetCellState()
    }
    
    override func layoutSubviews() {
        super.layoutSubviews()
        // Layout deÄŸiÅŸtiÄŸinde gradient'i gÃ¼ncelle
        updateGradientFrame()
    }
    
    // MARK: - Setup Methods
    
    /// UI bileÅŸenlerini yapÄ±landÄ±rÄ±r
    private func setupUI() {
        // Container view ayarlarÄ±
        containerView?.layer.cornerRadius = 20
        containerView?.layer.masksToBounds = true
        containerView?.backgroundColor = UIColor.clear
        
        // Background view ayarlarÄ±
        backgroundGradientView?.layer.cornerRadius = 20
        backgroundGradientView?.layer.masksToBounds = true
        
        // Ä°kon ayarlarÄ±
        iconImageView?.contentMode = .scaleAspectFit
        iconImageView?.tintColor = UIColor.white
        
        // BaÅŸlÄ±k ayarlarÄ±
        titleLabel?.font = UIFont.systemFont(ofSize: 14, weight: .bold)
        titleLabel?.textColor = UIColor.white
        titleLabel?.textAlignment = .center
        titleLabel?.numberOfLines = 2
        titleLabel?.adjustsFontSizeToFitWidth = true
        titleLabel?.minimumScaleFactor = 0.8
        
        // "YENÄ°" etiketi ayarlarÄ±
        newBadgeLabel?.font = UIFont.systemFont(ofSize: 10, weight: .bold)
        newBadgeLabel?.textColor = UIColor.white
        newBadgeLabel?.backgroundColor = UIColor.systemRed
        newBadgeLabel?.text = "YENÄ°"
        newBadgeLabel?.textAlignment = .center
        newBadgeLabel?.layer.cornerRadius = 9
        newBadgeLabel?.layer.masksToBounds = true
        newBadgeLabel?.isHidden = true
        
        // Shadow efekti
        setupShadow()
        
        // Accessibility ayarlarÄ±
        setupAccessibility()
        
        print("ðŸŽ¨ UI bileÅŸenleri ayarlandÄ±")
    }
    
    /// Liquid Glass efektini kurar
    private func setupLiquidGlass() {
        guard let container = containerView else { return }
        
        // Blur efekt view oluÅŸtur
        let blurEffect = UIBlurEffect(style: .systemUltraThinMaterialDark)
        blurEffectView = UIVisualEffectView(effect: blurEffect)
        blurEffectView?.frame = container.bounds
        blurEffectView?.autoresizingMask = [.flexibleWidth, .flexibleHeight]
        blurEffectView?.alpha = 0.7
        
        // Blur view'Ä± container'a ekle (en alta)
        if let blurView = blurEffectView {
            container.insertSubview(blurView, at: 0)
        }
        
        // Gradient layer oluÅŸtur
        gradientLayer = CAGradientLayer()
        gradientLayer?.frame = container.bounds
        gradientLayer?.cornerRadius = 20
        gradientLayer?.masksToBounds = true
        
        // Gradient'i blur view'Ä±n Ã¼zerine ekle
        if let gradient = gradientLayer {
            container.layer.insertSublayer(gradient, above: blurEffectView?.layer)
        }
        
        print("ðŸŒŸ Liquid glass efekti kuruldu")
    }
    
    /// GÃ¶lge efektini ayarlar
    private func setupShadow() {
        // Cell gÃ¶lge ayarlarÄ±
        layer.shadowColor = UIColor.black.cgColor
        layer.shadowOffset = CGSize(width: 0, height: 4)
        layer.shadowRadius = 12
        layer.shadowOpacity = 0.15
        layer.masksToBounds = false
        
        // Shadow path performance iÃ§in
        layer.shadowPath = UIBezierPath(roundedRect: bounds, cornerRadius: 20).cgPath
    }
    
    /// Accessibility ayarlarÄ±nÄ± yapar
    private func setupAccessibility() {
        isAccessibilityElement = true
        accessibilityTraits = .button
    }
    
    // MARK: - Configuration
    
    /// Cell'i verilen kategori ile yapÄ±landÄ±rÄ±r
    /// - Parameter category: MathCategory objesi
    func configure(with category: MathCategory) {
        self.category = category
        
        // BaÅŸlÄ±k ayarla
        titleLabel?.text = category.title
        
        // Ä°kon ayarla - Ã¶nce custom, sonra system icon dene
        if let customIcon = UIImage(named: category.iconName) {
            iconImageView?.image = customIcon
        } else if let systemIcon = UIImage(systemName: category.iconName) {
            iconImageView?.image = systemIcon
        } else {
            // Fallback icon
            iconImageView?.image = UIImage(systemName: "plus.circle.fill")
        }
        
        // Gradient renklerini ayarla
        updateGradientColors(category.backgroundColor)
        
        // "YENÄ°" etiketini gÃ¶ster/gizle
        newBadgeLabel?.isHidden = !category.isNew
        
        // Accessibility ayarlarÄ±
        accessibilityLabel = category.title
        accessibilityHint = category.isNew ? "\(category.title), yeni kategori" : category.title
        
        // Accessibility action'larÄ±nÄ± ayarla
        setupAccessibilityActions()
        
        // Animasyon efektlerini hazÄ±rla
        prepareAnimations()
        
        print("ðŸ”§ Cell configure edildi: \(category.title)")
    }
    
    // MARK: - Private Methods
    
    /// Gradient renklerini gÃ¼nceller
    /// - Parameter baseColor: Temel renk
    private func updateGradientColors(_ baseColor: UIColor) {
        // Renk tonlarÄ±nÄ± oluÅŸtur
        let lightColor = baseColor.withAlphaComponent(0.9)
        let darkColor = baseColor.withAlphaComponent(0.6)
        let accentColor = baseColor.withAlphaComponent(0.8)
        
        // Gradient renklerini ayarla
        gradientLayer?.colors = [
            lightColor.cgColor,
            accentColor.cgColor,
            darkColor.cgColor
        ]
        
        gradientLayer?.locations = [0.0, 0.5, 1.0]
        gradientLayer?.startPoint = CGPoint(x: 0.0, y: 0.0)
        gradientLayer?.endPoint = CGPoint(x: 1.0, y: 1.0)
        
        // Background view'a da renk ver (fallback)
        backgroundGradientView?.backgroundColor = baseColor
    }
    
    /// Gradient frame'ini gÃ¼nceller
    private func updateGradientFrame() {
        guard let container = containerView else { return }
        
        gradientLayer?.frame = container.bounds
        blurEffectView?.frame = container.bounds
        
        // Shadow path gÃ¼ncelle
        layer.shadowPath = UIBezierPath(roundedRect: bounds, cornerRadius: 20).cgPath
    }
    
    /// Cell durumunu sÄ±fÄ±rlar
    private func resetCellState() {
        category = nil
        titleLabel?.text = ""
        iconImageView?.image = nil
        newBadgeLabel?.isHidden = true
        
        // Transform ve alpha deÄŸerlerini sÄ±fÄ±rla
        transform = .identity
        alpha = 1.0
        
        // AnimasyonlarÄ± durdur
        layer.removeAllAnimations()
    }
    
    /// AnimasyonlarÄ± hazÄ±rlar
    private func prepareAnimations() {
        // Ä°lk load animation iÃ§in hazÄ±rlÄ±k
        alpha = 0.0
        transform = CGAffineTransform(scaleX: 0.8, y: 0.8) // DÃœZELTÄ°LDÄ°: scaleY kullanÄ±ldÄ±
    }
    
    // MARK: - Animation Methods
    
    /// GÃ¶rÃ¼nÃ¼m animasyonunu baÅŸlatÄ±r
    /// - Parameter delay: Animasyon gecikmesi
    func animateAppearance(withDelay delay: TimeInterval = 0.0) {
        UIView.animate(
            withDuration: 0.6,
            delay: delay,
            usingSpringWithDamping: 0.8,
            initialSpringVelocity: 0.5,
            options: [.allowUserInteraction, .curveEaseOut],
            animations: {
                self.alpha = 1.0
                self.transform = .identity
            },
            completion: nil
        )
    }
    
    /// SeÃ§im animasyonunu baÅŸlatÄ±r
    func animateSelection() {
        // Haptic feedback
        let impactFeedback = UIImpactFeedbackGenerator(style: .medium)
        impactFeedback.impactOccurred()
        
        // Visual feedback animasyonu
        UIView.animate(withDuration: 0.1, animations: {
            self.transform = CGAffineTransform(scaleX: 0.95, y: 0.95) // DÃœZELTÄ°LDÄ°
        }) { _ in
            UIView.animate(withDuration: 0.1, animations: {
                self.transform = .identity
            })
        }
        
        // Glow efekti
        addGlowEffect()
    }
    
    /// Glow efekti ekler
    private func addGlowEffect() {
        layer.shadowColor = category?.backgroundColor.cgColor ?? UIColor.white.cgColor
        layer.shadowRadius = 20
        layer.shadowOpacity = 0.6
        
        // Glow efektini yavaÅŸÃ§a kaldÄ±r
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { [weak self] in
            UIView.animate(withDuration: 0.3) {
                self?.layer.shadowColor = UIColor.black.cgColor
                self?.layer.shadowRadius = 12
                self?.layer.shadowOpacity = 0.15
            }
        }
    }
    
    /// Hover efektini baÅŸlatÄ±r (iPad iÃ§in)
    func animateHover(_ isHovering: Bool) {
        UIView.animate(withDuration: 0.2, animations: {
            if isHovering {
                self.transform = CGAffineTransform(scaleX: 1.05, y: 1.05) // DÃœZELTÄ°LDÄ°
                self.layer.shadowRadius = 16
                self.layer.shadowOpacity = 0.25
            } else {
                self.transform = .identity
                self.layer.shadowRadius = 12
                self.layer.shadowOpacity = 0.15
            }
        })
    }
}

// MARK: - Extensions
extension CategoryCollectionViewCell {
    
    /// Cell'in mevcut kategorisini dÃ¶ner
    var currentCategory: MathCategory? {
        return category
    }
    
    /// Cell'in seÃ§ilebilir olup olmadÄ±ÄŸÄ±nÄ± kontrol eder
    var isSelectable: Bool {
        return category != nil
    }
}

// MARK: - Accessibility
extension CategoryCollectionViewCell {
    
    /// Accessibility action'larÄ±nÄ± ayarlar
    private func setupAccessibilityActions() {
        guard let category = category else {
            accessibilityCustomActions = nil
            return
        }
        
        let selectAction = UIAccessibilityCustomAction(
            name: "\(category.title) kategorisini seÃ§",
            target: self,
            selector: #selector(accessibilitySelect)
        )
        
        accessibilityCustomActions = [selectAction]
    }
    
    /// Accessibility select action'Ä±
    @objc private func accessibilitySelect() -> Bool {
        // SeÃ§im animasyonu baÅŸlat
        animateSelection()
        return true
    }
}
